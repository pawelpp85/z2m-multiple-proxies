# Z2M Proxy Home Assistant Add-ons

Home Assistant add-ons for Zigbee2MQTT: lightweight ingress proxies plus an aggregated UI that merges multiple Z2M instances into one dashboard. Use this repository to pin multiple Zigbee2MQTT dashboards or manage devices across several Zigbee networks from a single aggregated Zigbee2MQTT interface.

Lightweight Home Assistant add-ons that only expose existing Zigbee2MQTT (Z2M) UI instances already running on your host (e.g., Docker containers). No Zigbee hardware or MQTT connectivity is provided here; each add-on is just an ingress-enabled reverse proxy so you can pin multiple Z2M dashboards in the sidebar.

This repository also includes the Zigbee2MQTT Migration tool add-on to ease device moves between Z2M instances. Besides helping remove/add devices, it checks where Home Assistant uses device IDs and entity IDs and repairs migration-related errors.

This repository is derived from the official Zigbee2MQTT Home Assistant proxy add-on ([zigbee2mqtt/hassio-zigbee2mqtt](https://github.com/zigbee2mqtt/hassio-zigbee2mqtt)) and was fully generated by ChatGPT/Codex based on that project. Huge thanks to the Zigbee2MQTT authors and the proxy add-on maintainers for the foundation.

## Included proxies

- `zigbee2mqtt_one` (UI title: Zigbee2MQTT One): defaults to `http://127.0.0.1:8099`
- `zigbee2mqtt_two` (UI title: Zigbee2MQTT Two): defaults to `http://127.0.0.1:8099`
- `zigbee2mqtt_three` (UI title: Zigbee2MQTT Three): defaults to `http://127.0.0.1:8099`
- `zigbee2mqtt_aggregated` (UI title: Zigbee2MQTT Aggregated): merges devices from multiple Z2M instances into a single UI with per-instance prefixes

Add more proxies by copying any of the proxy folders, adjusting the slug, panel title, and default `target_port`.

## Usage

1. Add this repository to Home Assistant as a custom add-on store.
2. Install the desired proxy add-on(s).
3. In each add-on configuration, set:
   - `server`: full URL of the existing Z2M UI **without a trailing slash** (e.g. `http://127.0.0.1:8486`). A trailing `/` can break routing and show a blank page.
   - `auth_token` (optional): token to append to the query string (same behavior as the official proxy).
4. Start the add-on. The Z2M UI will appear via ingress under the configured panel title and icon. With ingress and `panel_title` set, Home Assistant normally shows it in the sidebar; if not, enable “Show in sidebar” in the add-on UI.

## Notes

- These add-ons run with `host_network: false` and rely on ingress. If you need host access to a URL on the supervisor network, keep using full URLs like `http://127.0.0.1:PORT`.
- Because they only proxy HTTP, they do **not** manage Zigbee adapters, MQTT, or state.
- Each add-on ships with its own ingress port (8099/8100/8101) for internal binding; no host port is exposed by default.
- Built from the Home Assistant base image with a tiny nginx reverse proxy.

## Development workflow

After any change, bump the next beta version (e.g. `1.0.1b2`), commit, and run `git push`.

## Zigbee2MQTT via Dockage + Ansible

If you run standalone Zigbee2MQTT containers (e.g., on a NUC) and want to expose them in Home Assistant through these add-ons, you can provision Z2M with Dockage and/or Ansible. Below is a minimal example based on a single instance named "one" that you can copy for multiple networks by changing ports, device paths, and MQTT topics.

### Example docker-compose.yml (Dockage)

```yaml
services:
  zigbee2mqtt_one:
    container_name: zigbee2mqtt_one
    image: ghcr.io/koenkk/zigbee2mqtt
    restart: unless-stopped
    volumes:
      - /usr/share/compose-stacks/z2m_one/data:/app/data
      - /run/udev:/run/udev:ro
    ports:
      - 8486:8099
    environment:
      - TZ=Europe/Berlin
    devices:
      - /dev/zigbee-one:/dev/zigbee-one
```

In Dockage, create a new stack pointing at the folder containing this `docker-compose.yml` and bring it up. The Z2M UI will be available at `http://192.168.0.10:8486`.

### Mapping Zigbee USB devices

The line `- /dev/zigbee-one:/dev/zigbee-one` is a bind-mount of a Zigbee coordinator device from the host into the container. The left side is the host path; the right side is the path Z2M sees inside the container. This works best when you create a stable device alias (so it doesn't change after reboots).

To create a stable alias:

1. Identify your coordinator:
   - `ls -l /dev/serial/by-id/` (preferred; stable by USB ID)
   - `dmesg | tail` (to see recent USB/tty assignments)
2. Create a udev rule, for example:
   ```
   /etc/udev/rules.d/99-zigbee.rules
   SUBSYSTEM=="tty", ATTRS{idVendor}=="10c4", ATTRS{idProduct}=="ea60", SYMLINK+="zigbee-one"
   ```
3. Reload udev rules:
   ```
   udevadm control --reload-rules && udevadm trigger
   ```
4. Point Zigbee2MQTT at `/dev/zigbee-one` in `configuration.yaml` and use the same path in `docker-compose.yml`.

Why it matters with multiple coordinators:

- Prevents containers from accidentally grabbing the wrong adapter after a reboot.
- Makes each Z2M instance explicit and stable (e.g., one adapter per network).
- Avoids port conflicts when you run several coordinators on the same host.

### Example configuration.yaml

```yaml
devices:
  - devices.yaml
homeassistant:
  enabled: true
mqtt:
  base_topic: zigbee2mqtt-one
  server: mqtt://192.168.0.10:1883
  user: ha
  password: YOUR_MQTT_PASSWORD
serial:
  port: /dev/zigbee-one
  adapter: zstack
  disable_led: true
frontend:
  enabled: true
  port: 8099
advanced:
  pan_id: 19188
  channel: 15
  network_key: [5, 86, 12, 200, 33, 94, 17, 240, 99, 10, 76, 54, 211, 8, 130, 67]
  log_level: info
  last_seen: ISO_8601
device_options:
  homeassistant:
    last_seen:
      enabled_by_default: true
availability:
  enabled: true
  active:
    timeout: 120
  passive:
    timeout: 1800
version: 4
```

### Example Ansible role (Z2M + Dockage)

```yaml
- name: Ensure Dockage is installed
  ansible.builtin.apt:
    name: dockage
    state: present
    update_cache: true

- name: Create Zigbee2MQTT base directory
  file:
    path: /usr/share/compose-stacks/z2m_one
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create Zigbee2MQTT data directory
  file:
    path: /usr/share/compose-stacks/z2m_one/data
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Copy docker-compose.yml
  copy:
    src: docker-compose.yml
    dest: /usr/share/compose-stacks/z2m_one/docker-compose.yml
    owner: root
    group: root
    mode: "0644"

- name: Copy configuration.yaml
  copy:
    src: configuration.yaml
    dest: /usr/share/compose-stacks/z2m_one/data/configuration.yaml
    owner: root
    group: root
    mode: "0644"

- name: Ensure stack is up via Docker Compose V2
  community.docker.docker_compose_v2:
    project_src: /usr/share/compose-stacks/z2m_one
    state: present
```

When running Z2M outside HA, make sure you also implement backups for `/usr/share/compose-stacks/z2m_one/data` (e.g., Borg, rsync, snapshots), as that folder contains your Zigbee network state.

Once the container is running, point the HA proxy add-ons to `http://192.168.0.10:8486` (or use the aggregated add-on to merge multiple instances).

## Attribution & license

- Upstream project: [zigbee2mqtt/hassio-zigbee2mqtt](https://github.com/zigbee2mqtt/hassio-zigbee2mqtt) (Apache-2.0). No NOTICE file exists upstream as of writing.
- This project was automatically generated by ChatGPT/Codex based on the upstream proxy add-on.
- Apache-2.0 permits this derivative with attribution; the included `LICENSE` applies.
