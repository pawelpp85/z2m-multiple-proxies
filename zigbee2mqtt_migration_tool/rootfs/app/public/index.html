<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zigbee2MQTT Migration tool</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <div>
          <p class="eyebrow">Migration control</p>
          <h1>Zigbee2MQTT Migration tool</h1>
          <details class="subtitle instructions">
            <summary>How to use</summary>
            <div class="instruction-block">
              <h4>Overview</h4>
              <p>This tool helps migrate devices between Zigbee2MQTT instances, but it is not fully automatic.</p>
              <p>Configure the add-on with URLs for all your instances. The tool discovers devices, IEEE addresses, and names, and stores the mapping for future moves. Use the mapped name here instead of renaming directly in Zigbee2MQTT.</p>
            </div>
            <div class="instruction-block">
              <h4>Install codes</h4>
              <p>Before migrating, make sure an install code is stored for the device. Install codes are saved per IEEE address and can be scanned with the camera and added to the target instance.</p>
            </div>
            <div class="instruction-block">
              <h4>Migration steps</h4>
              <ol>
                <li>Enable pairing in exactly one Zigbee2MQTT instance (or use the pairing control here).</li>
                <li>Click “Migrate” for the device to remove it from its current instance.</li>
                <li>Put the device into pairing mode and follow the manufacturer or Zigbee2MQTT instructions.</li>
                <li>After the device joins the new instance and finishes the interview, the mapped name is applied automatically.</li>
              </ol>
            </div>
            <div class="instruction-block">
              <h4>Mapping tools</h4>
              <p><strong>Reset mappings</strong> reloads current names from all instances and removes mappings for devices not present in any instance.</p>
              <p><strong>Apply mappings</strong> checks for mismatched names and lets you confirm proposed changes.</p>
            </div>
            <div class="instruction-block">
              <h4>Home Assistant IDs</h4>
              <p><strong>Device ID</strong> is the internal Home Assistant device registry id (32‑char hex). It is assigned by HA and can change when the device is re‑discovered after migration.</p>
              <p><strong>Entity ID</strong> is the human‑readable id (e.g. <code>climate.living_room</code>). This can be renamed and restored.</p>
              <p><strong>Entity registry ID</strong> is the internal entity registry id (32‑char hex). Device triggers/actions in automations often store this value instead of the human‑readable entity_id.</p>
              <p><strong>Unique ID</strong> comes from Zigbee2MQTT discovery and is used by HA to match entities. It cannot be edited in HA.</p>
              <p><strong>HA IDs</strong> opens the panel for a device and shows snapshot vs current ids.</p>
              <ul>
                <li><strong>Save snapshot</strong>: fetches HA device + entity ids and stores them. This is required before migration.</li>
                <li><strong>Restore entity IDs</strong>: renames human‑readable entity_id values back to the snapshot. Does not change device_id or registry ids.</li>
                <li><strong>Scan</strong>: scans automations, scripts, and scenes and lists which ones will be changed.</li>
                <li><strong>Rewrite device IDs</strong>: applies device_id + registry id replacements to all affected automations, scripts, and scenes.</li>
              </ul>
              <p>If a field shows “-” it means there was no snapshot for that item at the time of migration.</p>
            </div>
          </details>
        </div>
        <div class="status-card" id="pairingStatus">
          <p class="status-body">Loading pairing status...</p>
          <div class="pairing-control" id="pairingControl"></div>
        </div>
      </header>

      <section class="overview">
        <div class="overview-card">
          <p class="label">Devices</p>
          <p class="value" id="overviewDevices">-</p>
        </div>
        <div class="overview-card">
          <p class="label">Online</p>
          <p class="value" id="overviewOnline">-</p>
        </div>
        <div class="overview-card">
          <p class="label">Router</p>
          <p class="value" id="overviewRouter">-</p>
        </div>
        <div class="overview-card">
          <p class="label">End device</p>
          <p class="value" id="overviewEnd">-</p>
        </div>
        <div class="overview-card accent">
          <p class="label">Low LQI</p>
          <p class="value" id="overviewLqi">-</p>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Recent activity</h2>
            <p>Combined logs from all configured instances.</p>
          </div>
        </div>
        <div class="activity" id="activityLog"></div>
      </section>

      <section class="panel">
        <div class="panel-header mapping-header">
          <div class="panel-title">
            <h2>Device mappings</h2>
            <p>Mapping is stored on disk and reused for future joins.</p>
          </div>
          <div class="mapping-controls">
            <input type="search" id="deviceSearch" placeholder="Search" />
            <div class="instance-filters" id="instanceFilters"></div>
          </div>
          <div class="counts-right">
            <span id="mappingCount">0 mappings</span>
            <button class="secondary danger" id="resetMappings">Reset mappings</button>
            <button class="secondary primary" id="applyMappings">Apply mappings</button>
          </div>
        </div>
        <div class="table" id="deviceTable">
          <div class="row header">
            <button class="sort" data-sort="mappedName">Mapped name</button>
            <button class="sort" data-sort="ieee">IEEE address</button>
            <button class="sort" data-sort="installCode">Install code</button>
            <button class="sort" data-sort="instances">Instances</button>
            <button class="sort" data-sort="type">Type</button>
            <button class="sort" data-sort="model">Model</button>
            <button class="sort" data-sort="lqi">LQI</button>
            <button class="sort" data-sort="online">Online</button>
            <div>Actions</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Coordinators</h2>
            <p>Coordinator details pulled from each Zigbee2MQTT instance.</p>
          </div>
          <div>
            <button class="ghost" id="coordinatorSaveAll">Save all coordinators</button>
          </div>
        </div>
        <div class="table coordinators" id="coordinatorTable">
          <div class="row header">
            <div>Instance</div>
            <div>Type</div>
            <div>IEEE address</div>
            <div>Revision</div>
            <div>Serial</div>
            <div>Meta</div>
            <div>Status</div>
          </div>
        </div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
    <div class="scanner hidden" id="qrScanner">
      <div class="scanner-inner">
        <video id="qrVideo" playsinline></video>
        <button class="secondary" id="qrClose">Close</button>
      </div>
    </div>
    <div class="modal hidden" id="mappingModal">
      <div class="modal-card">
        <h3>Mapping mismatch detected</h3>
        <p id="mappingModalText"></p>
        <div class="modal-actions">
          <button class="secondary" id="mappingCancel">Cancel</button>
          <button class="secondary primary" id="mappingApply">Change</button>
        </div>
      </div>
    </div>
    <div class="modal hidden" id="haModal">
      <div class="modal-card ha-modal-card">
        <div class="ha-modal-header">
          <div>
            <h3>Home Assistant IDs</h3>
            <p class="subtitle" id="haDeviceTitle">Loading...</p>
          </div>
          <button class="ghost" id="haClose">Close</button>
        </div>
        <div class="ha-section">
          <h4>Status</h4>
          <div class="ha-info" id="haStatus">Loading...</div>
        </div>
        <div class="ha-section">
          <h4>Snapshot</h4>
          <div class="ha-info" id="haSnapshotInfo">-</div>
          <div class="ha-actions">
            <button class="secondary" id="haSnapshot">Save snapshot</button>
            <button class="secondary primary" id="haRestore">Restore entity IDs</button>
          </div>
        </div>
        <div class="ha-section">
          <h4>Current device</h4>
          <div class="ha-info" id="haDeviceInfo">-</div>
        </div>
        <div class="ha-section">
          <h4>Entities</h4>
          <div class="ha-table" id="haEntityInfo"></div>
        </div>
        <div class="ha-section">
          <h4>Automations</h4>
          <div class="ha-info" id="haAutomationInfo">-</div>
          <div class="ha-list" id="haAutomationList"></div>
          <div class="ha-actions">
            <button
              class="secondary"
              id="haAutomationPreview"
              title="Scan automations, scripts, and scenes for device_id/entity registry id replacements. No changes are applied."
            >
              Scan
            </button>
            <button
              class="secondary danger"
              id="haAutomationApply"
              disabled
              title="Rewrite device_id and entity registry IDs across all affected automations, scripts, and scenes."
            >
              Rewrite device IDs
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="./app.js"></script>
  </body>
</html>
