<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zigbee2MQTT Migration tool</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <div>
          <p class="eyebrow">Migration control</p>
          <h1>Zigbee2MQTT Migration tool</h1>
          <details class="subtitle instructions">
            <summary>How to use</summary>
            <div class="instruction-block">
              <h4>Overview</h4>
              <p>This tool helps migrate devices between Zigbee2MQTT instances, but it is not fully automatic.</p>
              <p>Configure the add-on with URLs for all your instances. The tool discovers devices, IEEE addresses, and names, and stores the mapping for future moves. Use the mapped name here instead of renaming directly in Zigbee2MQTT.</p>
            </div>
            <div class="instruction-block">
              <h4>Install codes</h4>
              <p>Before migrating, make sure an install code is stored for the device. Install codes are saved per IEEE address and can be scanned with the camera and added to the target instance.</p>
            </div>
            <div class="instruction-block">
              <h4>Migration steps</h4>
              <ol>
                <li>Enable pairing in exactly one Zigbee2MQTT instance (or use the pairing control here).</li>
                <li>Click “Migrate” for the device to remove it from its current instance.</li>
                <li>Put the device into pairing mode and follow the manufacturer or Zigbee2MQTT instructions.</li>
                <li>After the device joins the new instance and finishes the interview, the mapped name is applied automatically.</li>
              </ol>
            </div>
            <div class="instruction-block">
              <h4>Mapping tools</h4>
              <p><strong>Reset mappings</strong> reloads current names from all instances and removes mappings for devices not present in any instance.</p>
              <p><strong>Apply mappings</strong> checks for mismatched names and lets you confirm proposed changes.</p>
            </div>
            <div class="instruction-block">
              <h4>Home Assistant IDs</h4>
              <p><strong>Device ID</strong> is the internal HA device registry ID (32‑char hex). <strong>Entity ID</strong> is the human-readable name (e.g. <code>climate.living_room</code>). <strong>Entity registry ID</strong> is a 32‑char hex used by device triggers/actions.</p>
              <p><strong>HA IDs</strong> opens the panel for a device.</p>
              <ul>
                <li><strong>Save snapshot</strong>: store device/entity IDs before migration (required).</li>
                <li><strong>Restore entity IDs</strong>: rename human‑readable entity IDs back to snapshot values.</li>
                <li><strong>Preview device_id rewrite</strong>: scan automations and show planned changes (all devices with snapshots).</li>
                <li><strong>Rewrite device IDs</strong>: apply automation changes for all snapshot devices.</li>
                <li><strong>Fix automations for this device</strong>: apply changes only for the currently opened device.</li>
              </ul>
            </div>
          </details>
        </div>
        <div class="status-card" id="pairingStatus">
          <p class="status-body">Loading pairing status...</p>
          <div class="pairing-control" id="pairingControl"></div>
        </div>
      </header>

      <section class="overview">
        <div class="overview-card">
          <p class="label">Devices</p>
          <p class="value" id="overviewDevices">-</p>
        </div>
        <div class="overview-card">
          <p class="label">Online</p>
          <p class="value" id="overviewOnline">-</p>
        </div>
        <div class="overview-card">
          <p class="label">Router</p>
          <p class="value" id="overviewRouter">-</p>
        </div>
        <div class="overview-card">
          <p class="label">End device</p>
          <p class="value" id="overviewEnd">-</p>
        </div>
        <div class="overview-card accent">
          <p class="label">Low LQI</p>
          <p class="value" id="overviewLqi">-</p>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Recent activity</h2>
            <p>Combined logs from all configured instances.</p>
          </div>
        </div>
        <div class="activity" id="activityLog"></div>
      </section>

      <section class="panel">
        <div class="panel-header mapping-header">
          <div class="panel-title">
            <h2>Device mappings</h2>
            <p>Mapping is stored on disk and reused for future joins.</p>
          </div>
          <div class="mapping-controls">
            <input type="search" id="deviceSearch" placeholder="Search" />
            <div class="instance-filters" id="instanceFilters"></div>
          </div>
          <div class="counts-right">
            <span id="mappingCount">0 mappings</span>
            <button class="secondary danger" id="resetMappings">Reset mappings</button>
            <button class="secondary primary" id="applyMappings">Apply mappings</button>
          </div>
        </div>
        <div class="table" id="deviceTable">
          <div class="row header">
            <button class="sort" data-sort="mappedName">Mapped name</button>
            <button class="sort" data-sort="ieee">IEEE address</button>
            <button class="sort" data-sort="installCode">Install code</button>
            <button class="sort" data-sort="instances">Instances</button>
            <button class="sort" data-sort="type">Type</button>
            <button class="sort" data-sort="model">Model</button>
            <button class="sort" data-sort="lqi">LQI</button>
            <button class="sort" data-sort="online">Online</button>
            <div>Actions</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <h2>Coordinators</h2>
            <p>Coordinator details pulled from each Zigbee2MQTT instance.</p>
          </div>
        </div>
        <div class="table coordinators" id="coordinatorTable">
          <div class="row header">
            <div>Instance</div>
            <div>Type</div>
            <div>IEEE address</div>
            <div>Revision</div>
            <div>Serial</div>
            <div>Meta</div>
            <div>Status</div>
            <div>Actions</div>
          </div>
        </div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
    <div class="scanner hidden" id="qrScanner">
      <div class="scanner-inner">
        <video id="qrVideo" playsinline></video>
        <button class="secondary" id="qrClose">Close</button>
      </div>
    </div>
    <div class="modal hidden" id="mappingModal">
      <div class="modal-card">
        <h3>Mapping mismatch detected</h3>
        <p id="mappingModalText"></p>
        <div class="modal-actions">
          <button class="secondary" id="mappingCancel">Cancel</button>
          <button class="secondary primary" id="mappingApply">Change</button>
        </div>
      </div>
    </div>
    <div class="modal hidden" id="haModal">
      <div class="modal-card ha-modal-card">
        <div class="ha-modal-header">
          <div>
            <h3>Home Assistant IDs</h3>
            <p class="subtitle" id="haDeviceTitle">Loading...</p>
          </div>
          <button class="ghost" id="haClose">Close</button>
        </div>
        <div class="ha-section">
          <h4>Status</h4>
          <div class="ha-info" id="haStatus">Loading...</div>
        </div>
        <div class="ha-section">
          <h4>Snapshot</h4>
          <div class="ha-info" id="haSnapshotInfo">-</div>
          <div class="ha-actions">
            <button class="secondary" id="haSnapshot">Save snapshot</button>
            <button class="secondary primary" id="haRestore">Restore entity IDs</button>
          </div>
        </div>
        <div class="ha-section">
          <h4>Current device</h4>
          <div class="ha-info" id="haDeviceInfo">-</div>
        </div>
        <div class="ha-section">
          <h4>Entities</h4>
          <div class="ha-table" id="haEntityInfo"></div>
        </div>
          <div class="ha-section">
          <h4>Automations</h4>
          <div class="ha-info" id="haAutomationInfo">-</div>
          <div class="ha-list" id="haAutomationList"></div>
          <div class="ha-info" id="haAutomationDeviceInfo">-</div>
          <div class="ha-actions">
            <button class="secondary" id="haAutomationPreview">Preview device_id rewrite</button>
            <button class="secondary danger" id="haAutomationApply" disabled>Rewrite device IDs</button>
            <button class="secondary" id="haAutomationDeviceApply" disabled>Fix automations for this device</button>
          </div>
        </div>
      </div>
    </div>

    <script src="./app.js"></script>
  </body>
</html>
